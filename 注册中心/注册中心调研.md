# 概述

服务注册中心（简称注册中心）是微服务架构中重要的一个组件，在微服务架构中起到了协调者的作用，因各公司的架构、规模、部署环境等不尽相同，所以注册中心在业界中有不同的实践。

相关的术语如下：

| 名词                               | 解释                                                         |
| ---------------------------------- | ------------------------------------------------------------ |
| 注册中心(Registry)                 | 服务注册中心，本文主要解释的微服务组件。                     |
| 注册中心客户端（Registry Client）  | 不管是服务提供者还是服务调用者，都算是注册中心的客户端，本文里简称客户端。 |
| 注册中心管理端（Registry Console） | 注册中心数据的管理端，本文里简称管理端 。                    |
| 服务(Service)                      | 一般是指一个接口，可以包括多个方法。例如订单服务包含有查询订单、新增订单等方法 |
| 服务提供者(Provider)               | 暴露一个监听端口，提供一到多个服务。                         |
| 服务调用者(Consumer)               | 连接服务提供者的端口，发起远程调用。                         |

# 注册中心功能

很多人将注册中心和配置中心混为一谈，一般认为因为服务注册的数据其实就是配置的一种，其实这样介绍不无道理，的确注册中心的数据是配置的一种。但是注册中心之所以独立的存在，因为注册中心的数据有一定的业务独立性，一般都是为了描述微服务相关的。

## 注册中心需求

注册中心一般需要包含如下功能： 服务发现、服务配置、服务健康检查；

**服务发现**

- 服务注册/反注册：保存服务提供者和服务调用者的信息。
- 服务订阅/取消订阅：服务调用者订阅服务提供者的信息，最好有实时推送的功能。
- 服务路由（可选）：具有筛选整合服务提供者的能力。

**服务配置（不包括其它无关配置）**

- 配置订阅：服务提供者和服务调用者订阅微服务相关的配置
- 配置下发（可选）：主动将配置推送给服务提供者和服务调用者

**服务健康检测**

- 检测服务提供者的健康情况

## 一致性分歧

分布式里一个重要的理论，那就是 CAP。在注册中心的发展上面，一直有两个分支：一个就是 CP 系统，追求数据的强一致性。还有一个是 AP 系统，追求高可用与最终一致。

## 为什么不用DNS

DNS 只是到 IP 级别，无法处理端口等信息。DNS 携带的数据较少，例如节点权重、序列化方式等等，无法传递。另外 DNS 没有节点状态管理功能，如果由外部系统刷新，那么将无法剔除死的节点。

# 功能对比

| Feature              | euerka                       | Consul                 | zookeeper             | etcd              |
| :------------------- | :--------------------------- | :--------------------- | :-------------------- | :---------------- |
| 服务健康检查         | 可配支持                     | 服务状态，内存，硬盘等 | (弱)长连接，keepalive | 连接心跳          |
| 多数据中心           | —                            | 支持                   | —                     | —                 |
| kv 存储服务          | —                            | 支持                   | 支持                  | 支持              |
| 负载均衡策略         | Ribbon                       | Fabio                  | —                     |                   |
| 一致性               | —                            | raft                   | paxos                 | raft              |
| cap                  | ap                           | cp                     | cp                    | cp                |
| 使用接口(多语言能力) | http（sidecar）              | 支持 http 和 dns       | 客户端                | http/grpc         |
| watch 支持           | 支持 long polling/大部分增量 | 全量/支持long polling  | 支持                  | 支持 long polling |
| 自身监控             | metrics                      | metrics                | —                     | metrics           |
| 安全                 | —                            | acl /https             | acl                   | https 支持（弱）  |
| spring cloud 集成    | 已支持                       | 已支持                 | 已支持                | 已支持            |

# 健康检查

Zookeeper、Eureka都实现了一种TTL机制（Time To Live），如果客户端在一定的时间内没有向注册中心发送心跳后，则会将这个客户端摘除；

Consul也支持TTL方式，但是提供了更加全面的健康检查方式；

健康检查的方式分为**客户端健康检查**和**服务端健康检查**，客户端健康检查和服务端健康检查有一些不同的关注点；

## 客户端健康检查

客户端健康检查主要关注**客户端上报心跳的方式**、**服务端摘除不健康客户端的机制**；



## 服务端健康检查

服务端健康检查则关注探测客户端的方式、灵敏度以及设置客户端健康状态的机制；



## 两种方式对比

| 方式       | 实现                                                         | 实例剔除                                                     |
| :--------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 客户端探测 | 从实现复杂性上来讲，服务端探测肯定会更加复杂，因为服务端根据注册服务配置的健康检查方式，去执行响应的接口，判断响应的返回结果，并做好重试机制和线程池管理。 | 服务端健康检查**无法摘除**不健康实例，这意味只要注册过的服务实例，只要不调用接口主动注销，这些服务实例都需要去维护健康检查的探测任务； |
| 服务端探测 | 客户端探测从实现上只需要等待心跳，然后刷新TTL；              | 可以摘除不健康实例，减轻服务端的压力。                       |



# 负载均衡

负载均衡严格的来讲，并不算传统注册中心的功能。一般来讲服务发现的完整流程应该是先从注册中心获取服务的实例列表，然后根据自身的需求，来选择其中的部分实例或按照一定的流量分配机制来访问不同的服务提供者，因此注册中心本身不限定服务消费者的访问策略；

Eureka、Zookeeper和Consul本身没有去实现可配置及可扩展的负载均衡策略机制，**Eureka**的负载均衡是由**Ribbon**来完成，**Consul**则是利用**Fabio**做负载均衡；



# 参考

1. [主流微服务注册中心浅析和对比]
2. [服务注册中心架构演进](
